 
Hello everyone !

I have been using ROS and Cartographer for my current robotics internship, therefore I'm quite new.
The lab I work at uses turtlebots with LiDars and I was tasked to make that work with Cartographer 2D, that worked. However they now ask me to do the same with cartographer 3D with a Kinect sensor.

There are surprisingly few posts about Kinect and Cartographer, and none helped me solve my problem.

I use freenect and record every topics from the robot. I tried modifying a lua file to use pointclould data and TRAJECTORY_BUILDER_3D but no matter what I do, cartographer crashes.



$ roslaunch mobro turtlebot_slam_kinect.launch file:=/home/louis/ros/3dD4
... logging to /home/louis/.ros/log/ff672a16-aa27-11e9-b1a6-4c3488fa19cd/roslaunch-petrel-31164.log
Checking log directory for disk usage. This may take awhile.
Press Ctrl-C to interrupt
Done checking log file disk usage. Usage is <1GB.

started roslaunch server http://petrel:35741/

SUMMARY
========

PARAMETERS
 * /robot_description: <?xml version="1....
 * /rosdistro: melodic
 * /rosversion: 1.14.3
 * /use_sim_time: False

NODES
  /
    cartographer_occupancy_grid_node (cartographer_ros/cartographer_occupancy_grid_node)
    cartographer_offline_node (cartographer_ros/cartographer_offline_node)
    map_saver_trigger (mobro/map_saver)
    robot_state_publisher (robot_state_publisher/state_publisher)
    rviz (rviz/rviz)
    static_transform_publisher_base_footprint (tf/static_transform_publisher)
    static_transform_publisher_base_link (tf/static_transform_publisher)
    static_transform_publisher_wheel_left_link (tf/static_transform_publisher)
    static_transform_publisher_wheel_right_link (tf/static_transform_publisher)

auto-starting new master
process[master]: started with pid [31177]
ROS_MASTER_URI=http://localhost:11311

setting /run_id to ff672a16-aa27-11e9-b1a6-4c3488fa19cd
process[rosout-1]: started with pid [31189]
started core service [/rosout]
process[static_transform_publisher_base_link-2]: started with pid [31195]
process[static_transform_publisher_base_footprint-3]: started with pid [31198]
process[static_transform_publisher_wheel_left_link-4]: started with pid [31199]
process[static_transform_publisher_wheel_right_link-5]: started with pid [31205]
process[robot_state_publisher-6]: started with pid [31212]
process[rviz-7]: started with pid [31221]
process[cartographer_offline_node-8]: started with pid [31228]
process[cartographer_occupancy_grid_node-9]: started with pid [31230]
process[map_saver_trigger-10]: started with pid [31231]
[ INFO] [1563542439.215261475]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/ros/src/MOBRO_ROS/config/turtlebot_urg_lidar_3d.lua' for 'turtlebot_urg_lidar_3d.lua'.
[ INFO] [1563542439.217560208]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/map_builder.lua' for 'map_builder.lua'.
[ INFO] [1563542439.217863034]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/map_builder.lua' for 'map_builder.lua'.
[ INFO] [1563542439.218173982]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/pose_graph.lua' for 'pose_graph.lua'.
[ INFO] [1563542439.218516918]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/pose_graph.lua' for 'pose_graph.lua'.
[ INFO] [1563542439.218863298]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/trajectory_builder.lua' for 'trajectory_builder.lua'.
[ INFO] [1563542439.219115705]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/trajectory_builder.lua' for 'trajectory_builder.lua'.
[ INFO] [1563542439.219347369]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/trajectory_builder_2d.lua' for 'trajectory_builder_2d.lua'.
[ INFO] [1563542439.219596987]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/trajectory_builder_2d.lua' for 'trajectory_builder_2d.lua'.
[ INFO] [1563542439.219924923]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/trajectory_builder_3d.lua' for 'trajectory_builder_3d.lua'.
[ INFO] [1563542439.220113160]: I0719 15:20:39.000000 31228 configuration_file_resolver.cc:41] Found '/home/louis/catkin_ws/install_isolated/share/cartographer/configuration_files/trajectory_builder_3d.lua' for 'trajectory_builder_3d.lua'.
terminate called after throwing an instance of 'rosbag::BagIOException'
  what():  Error opening file: /home/louis/ros/src/MOBRO_ROS/bag//home/louis/ros/3dD4.bag
[cartographer_offline_node-8] process has died [pid 31228, exit code -6, cmd /home/louis/ros/install_isolated/lib/cartographer_ros/cartographer_offline_node -configuration_directory /home/louis/ros/src/MOBRO_ROS/config -configuration_basenames turtlebot_urg_lidar_3d.lua -bag_filenames /home/louis/ros/src/MOBRO_ROS/bag//home/louis/ros/3dD4.bag /camera/depth_registered/points:=points2 __name:=cartographer_offline_node __log:=/home/louis/.ros/log/ff672a16-aa27-11e9-b1a6-4c3488fa19cd/cartographer_offline_node-8.log].
log file: /home/louis/.ros/log/ff672a16-aa27-11e9-b1a6-4c3488fa19cd/cartographer_offline_node-8*.log
/home/louis/ros/src/MOBRO_ROS/bag/map_saver:13: SyntaxWarning: The publisher should be created with an explicit keyword argument 'queue_size'. Please see http://wiki.ros.org/rospy/Overview/Publishers%20and%20Subscribers for more information.
  self.pub = rospy.Publisher('/map',OccupancyGrid)




I tried looking at the logs it said it created but they don't actually exist..
  
I tried rosbag_validate and it shows errors about IMU data I don't use, gaps in the data that sould not crash cartographer and "Sensor with frame_id "gyro_link" jumps backwards in time.". I don't really know what to do about it as I haven't modified the data sent by the sensor.




$ cartographer_rosbag_validate -bag_filename /home/louis/ros/3dD4.bag 
E0719 15:21:28.426426 31388 rosbag_validate_main.cc:350] frame_id "odom" on topic /odom has serialization time 1563541524.021554156 but sensor time 1563541522.079008800 differing by -1.94255 s.
E0719 15:21:28.426743 31388 rosbag_validate_main.cc:350] frame_id "odom" on topic /odom has serialization time 1563541524.026883210 but sensor time 1563541522.101030762 differing by -1.92585 s.
E0719 15:21:28.426815 31388 rosbag_validate_main.cc:350] frame_id "odom" on topic /odom has serialization time 1563541524.026922288 but sensor time 1563541522.160195826 differing by -1.86673 s.
W0719 15:21:28.429309 31388 rosbag_validate_main.cc:103] frame_id gyro_link time 1563541523504935492: IMU linear acceleration is 0 m/s^2, expected is [3, 30] m/s^2. (It should include gravity and be given in m/s^2.) linear_acceleration 0 0 0
W0719 15:21:28.429368 31388 rosbag_validate_main.cc:103] frame_id gyro_link time 1563541523514935492: IMU linear acceleration is 0 m/s^2, expected is [3, 30] m/s^2. (It should include gravity and be given in m/s^2.) linear_acceleration 0 0 0
W0719 15:21:28.429533 31388 rosbag_validate_main.cc:103] frame_id gyro_link time 1563541523526811470: IMU linear acceleration is 0 m/s^2, expected is [3, 30] m/s^2. (It should include gravity and be given in m/s^2.) linear_acceleration 0 0 0
W0719 15:21:28.429949 31388 rosbag_validate_main.cc:352] frame_id "gyro_link" on topic /mobile_base/sensors/imu_data_raw has serialization time 1563541524.110294682 but sensor time 1563541523.616835361 differing by -0.493459 s.
E0719 15:21:28.430335 31388 rosbag_validate_main.cc:326] frame_id "gyro_link" is send on multiple topics. It was seen at least on /mobile_base/sensors/imu_data_raw and /mobile_base/sensors/imu_data
E0719 15:21:28.430410 31388 rosbag_validate_main.cc:315] Sensor with frame_id "gyro_link" jumps backwards in time. Make sure that the bag contains the data for each frame_id sorted by header.stamp, i.e. the order in which they were acquired from the sensor.
E0719 15:21:28.430564 31388 rosbag_validate_main.cc:326] frame_id "gyro_link" is send on multiple topics. It was seen at least on /mobile_base/sensors/imu_data_raw and /mobile_base/sensors/imu_data
E0719 15:21:28.430841 31388 rosbag_validate_main.cc:326] frame_id "gyro_link" is send on multiple topics. It was seen at least on /mobile_base/sensors/imu_data_raw and /mobile_base/sensors/imu_data
E0719 15:21:28.430881 31388 rosbag_validate_main.cc:315] Sensor with frame_id "gyro_link" jumps backwards in time. Make sure that the bag contains the data for each frame_id sorted by header.stamp, i.e. the order in which they were acquired from the sensor.
E0719 15:21:28.433492 31388 rosbag_validate_main.cc:315] Sensor with frame_id "gyro_link" jumps backwards in time. Make sure that the bag contains the data for each frame_id sorted by header.stamp, i.e. the order in which they were acquired from the sensor.
E0719 15:21:28.810129 31388 rosbag_validate_main.cc:365] Average IMU linear acceleration is 0 m/s^2, expected is [9.5, 10.5] m/s^2. Linear acceleration data should include gravity and be given in m/s^2.
E0719 15:21:28.810171 31388 rosbag_validate_main.cc:382] Point data (frame_id: "camera_depth_optical_frame") has a large gap, largest is 0.499492 s, recommended is [0.0005, 0.05] s with no jitter.
I0719 15:21:28.810195 31388 rosbag_validate_main.cc:398] Time delta histogram for consecutive messages on topic "/camera/depth/points" (frame_id: "camera_depth_optical_frame"):
Count: 17  Min: 0.027343  Max: 0.499492  Mean: 0.161513
[0.027343, 0.074558)                      ##    Count: 2 (11.764706%)   Total: 2 (11.764706%)
[0.074558, 0.121773)                   #####    Count: 4 (23.529411%)   Total: 6 (35.294117%)
[0.121773, 0.168988)                  ######    Count: 5 (29.411764%)   Total: 11 (64.705879%)
[0.168988, 0.216203)                    ####    Count: 3 (17.647058%)   Total: 14 (82.352943%)
[0.216203, 0.263418)                      ##    Count: 2 (11.764706%)   Total: 16 (94.117645%)
[0.263418, 0.310633)                            Count: 0 (0.000000%)    Total: 16 (94.117645%)
[0.310633, 0.357848)                            Count: 0 (0.000000%)    Total: 16 (94.117645%)
[0.357848, 0.405063)                            Count: 0 (0.000000%)    Total: 16 (94.117645%)
[0.405063, 0.452278)                            Count: 0 (0.000000%)    Total: 16 (94.117645%)
[0.452278, 0.499492]                       #    Count: 1 (5.882353%)    Total: 17 (100.000000%)
E0719 15:21:28.810308 31388 rosbag_validate_main.cc:382] Point data (frame_id: "camera_rgb_optical_frame") has a large gap, largest is 1.06636 s, recommended is [0.0005, 0.05] s with no jitter.
I0719 15:21:28.810335 31388 rosbag_validate_main.cc:398] Time delta histogram for consecutive messages on topic "/camera/depth_registered/points" (frame_id: "camera_rgb_optical_frame"):
Count: 2  Min: 0.334448  Max: 1.066361  Mean: 0.700405
[0.334448, 0.407640)              ##########    Count: 1 (50.000000%)   Total: 1 (50.000000%)
[0.407640, 0.480831)                            Count: 0 (0.000000%)    Total: 1 (50.000000%)
[0.480831, 0.554022)                            Count: 0 (0.000000%)    Total: 1 (50.000000%)
[0.554022, 0.627214)                            Count: 0 (0.000000%)    Total: 1 (50.000000%)
[0.627214, 0.700405)                            Count: 0 (0.000000%)    Total: 1 (50.000000%)
[0.700405, 0.773596)                            Count: 0 (0.000000%)    Total: 1 (50.000000%)
[0.773596, 0.846787)                            Count: 0 (0.000000%)    Total: 1 (50.000000%)
[0.846787, 0.919979)                            Count: 0 (0.000000%)    Total: 1 (50.000000%)
[0.919979, 0.993170)                            Count: 0 (0.000000%)    Total: 1 (50.000000%)
[0.993170, 1.066361]              ##########    Count: 1 (50.000000%)   Total: 2 (100.000000%)
E0719 15:21:28.810438 31388 rosbag_validate_main.cc:389] IMU data (frame_id: "gyro_link") has a large gap, largest is 0.297364 s, recommended is [0.0005, 0.005] s with no jitter.
I0719 15:21:28.810478 31388 rosbag_validate_main.cc:398] Time delta histogram for consecutive messages on topic "/mobile_base/sensors/imu_data_raw" (frame_id: "gyro_link"):
Count: 319  Min: -0.909285  Max: 0.297364  Mean: 0.016799
[-0.909285, -0.788620)                          Count: 1 (0.313480%)    Total: 1 (0.313480%)
[-0.788620, -0.667955)                          Count: 0 (0.000000%)    Total: 1 (0.313480%)
[-0.667955, -0.547290)                          Count: 0 (0.000000%)    Total: 1 (0.313480%)
[-0.547290, -0.426625)                          Count: 0 (0.000000%)    Total: 1 (0.313480%)
[-0.426625, -0.305961)                          Count: 1 (0.313480%)    Total: 2 (0.626959%)
[-0.305961, -0.185296)                          Count: 1 (0.313480%)    Total: 3 (0.940439%)
[-0.185296, -0.064631)                     #    Count: 8 (2.507837%)    Total: 11 (3.448276%)
[-0.064631, 0.056034)        ###############    Count: 238 (74.608147%) Total: 249 (78.056427%)
[0.056034, 0.176699)                    ####    Count: 67 (21.003136%)  Total: 316 (99.059563%)
[0.176699, 0.297364]                            Count: 3 (0.940439%)    Total: 319 (100.000000%)
I0719 15:21:28.810583 31388 rosbag_validate_main.cc:398] Time delta histogram for consecutive messages on topic "/odom" (frame_id: "odom"):
Count: 134  Min: 0.019648  Max: 0.297331  Mean: 0.050633
[0.019648, 0.047416)                  ######    Count: 37 (27.611940%)  Total: 37 (27.611940%)
[0.047416, 0.075184)          ##############    Count: 96 (71.641792%)  Total: 133 (99.253731%)
[0.075184, 0.102953)                            Count: 0 (0.000000%)    Total: 133 (99.253731%)
[0.102953, 0.130721)                            Count: 0 (0.000000%)    Total: 133 (99.253731%)
[0.130721, 0.158489)                            Count: 0 (0.000000%)    Total: 133 (99.253731%)
[0.158489, 0.186258)                            Count: 0 (0.000000%)    Total: 133 (99.253731%)
[0.186258, 0.214026)                            Count: 0 (0.000000%)    Total: 133 (99.253731%)
[0.214026, 0.241794)                            Count: 0 (0.000000%)    Total: 133 (99.253731%)
[0.241794, 0.269563)                            Count: 0 (0.000000%)    Total: 133 (99.253731%)
[0.269563, 0.297331]                            Count: 1 (0.746269%)    Total: 134 (100.000000%)




Cartographer is supposed to work with a pointcloud2 message nammed points2. The Kinect actually gives two pointcloud2 messages : /camera/depth/points and /camera/depth_registered/points but I don't know which one is used. I have tried to put a remap tag in the launch file but I don't think there is any documentation explaining where to put it. It didn't solve the issue.

Here is the git of my ros folder and the bag file.
